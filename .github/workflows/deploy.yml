name: Deploy Beauty Platform

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Setup pnpm
      uses: pnpm/action-setup@v4
      with:
        version: 9
        
    - name: Setup Node.js 22.x
      uses: actions/setup-node@v4
      with:
        node-version: '22.x'
        cache: 'pnpm'
        
    - name: Install deps
      run: pnpm install --frozen-lockfile
      
    - name: Remove conflicting config files
      run: |
        # Remove ALL conflicting Next.js/Vite config files
        find . -name "next.config.ts" -not -path "./node_modules/*" -delete || true
        find . -name "vite.config.ts" -path "*/web-booking/*" -delete || true
        
    - name: Try building web-booking
      run: |
        cd apps/web-booking
        if pnpm build; then
          echo "Web-booking build successful"
          mkdir -p ../../docs
          if [ -d "out" ]; then
            cp -r out/* ../../docs/
          elif [ -d "dist" ]; then
            cp -r dist/* ../../docs/
          fi
        else
          echo "Web-booking build failed, using static landing page"
        fi
        
    - name: Upload artifact
      if: github.ref == 'refs/heads/main'
      uses: actions/upload-pages-artifact@v2
      with:
        path: docs/
        
    - name: Deploy to Vercel
      if: github.ref == 'refs/heads/main'
      env:
        VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
        VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
        VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
      run: |
        if [ -n "$VERCEL_TOKEN" ]; then
          npm install -g vercel@latest
          cd apps/web-booking
          if [ -d "out" ]; then
            vercel deploy --prod --yes --token $VERCEL_TOKEN
          else
            echo "No build output found for Vercel deployment"
          fi
        else
          echo "Vercel secrets not configured, skipping deployment"
        fi

  deploy-pages:
    if: github.ref == 'refs/heads/main'
    needs: build
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
